<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PhotoNest 管理后台</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700&family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #f2f6fc;
  --panel: rgba(255,255,255,.74);
  --line: rgba(15,23,42,.08);
  --text: #10203c;
  --muted: #667894;
  --accent: #0a84ff;
  --ok: #10b981;
  --warn: #f59e0b;
  --danger: #ef4444;
}
* { box-sizing: border-box; }
body {
  margin: 0;
  color: var(--text);
  font-family: "Outfit", "Noto Sans SC", sans-serif;
  background:
    radial-gradient(circle at 6% -10%, #d8ebff 0%, transparent 34%),
    radial-gradient(circle at 92% 110%, #d4f7e6 0%, transparent 36%),
    var(--bg);
}
.topbar {
  position: sticky;
  top: 8px;
  z-index: 30;
  margin: 12px;
  border-radius: 22px;
  border: 1px solid var(--line);
  background: var(--panel);
  backdrop-filter: blur(14px) saturate(1.1);
  padding: 10px 14px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 10px;
}
.brand {
  display: flex;
  align-items: center;
  gap: 10px;
}
.brand-logo {
  width: 34px;
  height: 34px;
  border-radius: 10px;
  box-shadow: 0 8px 18px rgba(10, 132, 255, 0.25);
}
.title { font-size: 18px; font-weight: 650; letter-spacing: -0.02em; }
.controls { display: flex; gap: 8px; flex-wrap: wrap; }
.btn {
  height: 34px;
  border: 1px solid var(--line);
  border-radius: 10px;
  background: rgba(255,255,255,.9);
  padding: 0 12px;
  font-size: 13px;
  cursor: pointer;
}
.btn:disabled {
  opacity: .55;
  cursor: not-allowed;
}
.btn.primary {
  border: none;
  color: #fff;
  background: linear-gradient(180deg, #1b8fff, #0a84ff);
}
.btn.warn {
  border: none;
  color: #fff;
  background: linear-gradient(180deg, #f59e0b, #d97706);
}
.btn.danger {
  border: none;
  color: #fff;
  background: linear-gradient(180deg, #ef4444, #dc2626);
}
.container {
  max-width: 1500px;
  margin: 0 auto;
  padding: 0 16px 34px;
  display: grid;
  grid-template-columns: repeat(12, minmax(0, 1fr));
  gap: 14px;
}
.card {
  border: 1px solid var(--line);
  border-radius: 20px;
  background: var(--panel);
  backdrop-filter: blur(14px);
  box-shadow: 0 22px 60px rgba(15,23,42,.1);
  padding: 16px;
}
.card h3 { margin: 0 0 10px; font-size: 16px; }
.muted { color: var(--muted); font-size: 12px; }
label {
  display: block;
  font-size: 12px;
  color: var(--muted);
  margin-bottom: 6px;
}
input, textarea, select {
  width: 100%;
  border: 1px solid var(--line);
  border-radius: 11px;
  background: rgba(255,255,255,.86);
  min-height: 36px;
  padding: 8px 10px;
  font-size: 13px;
  outline: none;
}
input:focus, textarea:focus, select:focus {
  border-color: rgba(10,132,255,.4);
  box-shadow: 0 0 0 3px rgba(10,132,255,.12);
}
textarea { min-height: 70px; resize: vertical; }
.row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
.row3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 10px; }
.row4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 10px; }
.stack { display: flex; flex-direction: column; gap: 10px; }
.table-wrap {
  border: 1px solid var(--line);
  border-radius: 12px;
  overflow: auto;
  max-height: 420px;
}
table { width: 100%; border-collapse: collapse; font-size: 12px; }
th, td { padding: 9px 8px; border-bottom: 1px solid var(--line); text-align: left; vertical-align: top; }
th { background: rgba(255,255,255,.8); position: sticky; top: 0; z-index: 1; }
.badge {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  border: 1px solid var(--line);
  border-radius: 999px;
  padding: 4px 9px;
  font-size: 11px;
  background: rgba(255,255,255,.86);
}
.dot { width: 7px; height: 7px; border-radius: 99px; background: var(--ok); }
.dot.warn { background: var(--warn); }
.small-btn {
  border: 1px solid var(--line);
  background: rgba(255,255,255,.9);
  border-radius: 8px;
  height: 28px;
  padding: 0 8px;
  font-size: 11px;
  cursor: pointer;
}
.checkbox-list {
  max-height: 180px;
  overflow: auto;
  border: 1px solid var(--line);
  border-radius: 12px;
  padding: 8px;
  background: rgba(255,255,255,.86);
}
.checkbox-list label {
  display: flex;
  align-items: center;
  gap: 8px;
  color: var(--text);
  margin: 0;
  padding: 5px 2px;
}
.checkbox-list input { width: auto; min-height: auto; }
.status-line { font-size: 12px; color: var(--muted); line-height: 1.6; white-space: pre-wrap; }
.progress-stack { margin-top: 8px; display: grid; gap: 10px; }
.progress-item { background: rgba(255,255,255,.84); border: 1px solid var(--line); border-radius: 12px; padding: 10px; }
.progress-head { display: flex; justify-content: space-between; align-items: center; font-size: 12px; color: var(--muted); margin-bottom: 7px; }
.progress-title { font-weight: 600; color: var(--text); }
.progress-track { width: 100%; height: 8px; border-radius: 999px; background: rgba(15,23,42,.08); overflow: hidden; }
.progress-fill { height: 100%; width: 0%; background: linear-gradient(90deg, #0a84ff, #3ea4ff); transition: width .35s ease; }
#transcode-progress-fill { background: linear-gradient(90deg, #10b981, #44d6a3); }
.modal-mask {
  position: fixed;
  inset: 0;
  z-index: 90;
  background: rgba(2, 8, 23, .5);
  display: none;
  align-items: center;
  justify-content: center;
  padding: 16px;
}
.modal-mask.show { display: flex; }
.modal-card {
  width: min(760px, 100%);
  max-height: calc(100vh - 36px);
  overflow: auto;
  border-radius: 16px;
  border: 1px solid var(--line);
  background: rgba(255,255,255,.96);
  box-shadow: 0 24px 68px rgba(15,23,42,.22);
  padding: 14px;
}
.modal-head {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 8px;
  margin-bottom: 8px;
}
.modal-title { font-size: 15px; font-weight: 650; }
.update-log {
  min-height: 180px;
  max-height: 320px;
  overflow: auto;
  margin: 8px 0 0;
  padding: 10px;
  border-radius: 11px;
  border: 1px solid var(--line);
  background: rgba(15,23,42,.04);
  font-size: 12px;
  line-height: 1.5;
  white-space: pre-wrap;
}
#settings-card { grid-column: span 5; }
#scan-card { grid-column: span 7; }
#users-card { grid-column: span 6; }
#albums-card { grid-column: span 6; }
#acl-card { grid-column: span 12; }
@media (max-width: 1100px) {
  #settings-card, #scan-card, #users-card, #albums-card, #acl-card { grid-column: span 12; }
  .row, .row3, .row4 { grid-template-columns: 1fr; }
}
</style>
</head>
<body>
<header class="topbar">
  <div class="brand">
    <img class="brand-logo" src="/static/photonest-logo.svg" alt="PhotoNest logo">
    <div class="title">PhotoNest 管理后台</div>
  </div>
  <div class="controls">
    <span class="badge"><span class="dot"></span>{{ user.username }} · 管理员</span>
    <button class="btn" onclick="window.location.href='/'">返回相册</button>
    <button class="btn" onclick="logout()">退出登录</button>
  </div>
</header>

<main class="container">
  <section class="card" id="settings-card">
    <h3>系统设置</h3>
    <div class="muted">路径、扫描限额、并发参数</div>
    <div style="height:10px"></div>

    <div class="stack">
      <div>
        <label>原图目录 (PHOTO_ROOT)</label>
        <input id="photo_root" placeholder="/mnt/nas/photos">
      </div>
      <div>
        <label>缓存目录 (CACHE_ROOT)</label>
        <input id="cache_root" placeholder="/var/lib/photopanel/cache">
      </div>

      <div class="row3">
        <div>
          <label>MAX_SCAN_ALBUMS_PER_RUN</label>
          <input id="max_scan_albums_per_run" type="number" min="1">
        </div>
        <div>
          <label>MAX_SCAN_FILES_PER_ALBUM</label>
          <input id="max_scan_files_per_album" type="number" min="10">
        </div>
        <div>
          <label>MAX_NEW_THUMBS_PER_RUN</label>
          <input id="max_new_thumbs_per_run" type="number" min="1">
        </div>
      </div>

      <div class="row3">
        <div>
          <label>WORKERS</label>
          <input id="workers" type="number" min="1" max="16">
        </div>
        <div>
          <label>TIME_BUDGET_SECONDS</label>
          <input id="time_budget_seconds" type="number" min="10">
        </div>
        <div>
          <label>PREHEAT_COUNT (发布后预热)</label>
          <input id="preheat_count" type="number" min="0">
        </div>
      </div>

      <div class="row3">
        <div>
          <label>THUMB_MAX_EDGE (px)</label>
          <input id="thumb_max_edge" type="number" min="240" max="1024">
        </div>
        <div>
          <label>PREVIEW_MAX_EDGE (px)</label>
          <input id="preview_max_edge" type="number" min="960" max="3840">
        </div>
        <div>
          <label>WEBP_METHOD (0-6)</label>
          <input id="webp_method" type="number" min="0" max="6">
        </div>
      </div>

      <div class="row3">
        <div>
          <label>THUMB_QUALITY (50-92)</label>
          <input id="thumb_quality" type="number" min="50" max="92">
        </div>
        <div>
          <label>PREVIEW_QUALITY (55-95)</label>
          <input id="preview_quality" type="number" min="55" max="95">
        </div>
        <div>
          <label>THUMB_TARGET_KB</label>
          <input id="thumb_target_kb" type="number" min="40" max="600">
        </div>
      </div>

      <div class="row3">
        <div>
          <label>PREVIEW_TARGET_KB</label>
          <input id="preview_target_kb" type="number" min="200" max="6000">
        </div>
        <div></div>
        <div></div>
      </div>

      <div class="row">
        <div>
          <label>允许扩展名 (逗号分隔)</label>
          <input id="allowed_extensions" placeholder=".jpg,.jpeg,.png,.webp,.heic,.heif">
        </div>
        <div>
          <label>排除目录 (逗号分隔)</label>
          <input id="exclude_dirs" placeholder="@eaDir,.git,.cache,.thumbnails">
        </div>
      </div>

      <div style="display:flex;gap:8px;flex-wrap:wrap;">
        <button class="btn primary" id="save-settings-btn" onclick="saveSettings()">保存设置</button>
        <button class="btn" id="panel-update-btn" onclick="startPanelUpdate()">一键更新面板</button>
      </div>
    </div>
  </section>

  <section class="card" id="scan-card">
    <h3>扫描任务</h3>
    <div class="muted">支持按年份/项目定向扫描，增量索引 + 限流执行</div>
    <div style="height:10px"></div>

    <div class="row">
      <div>
        <label>只扫年份（逗号分隔，可空）</label>
        <input id="scan_years" placeholder="2025,2026">
      </div>
      <div>
        <label>只扫项目路径（每行一个，可空）</label>
        <textarea id="scan_album_paths" placeholder="2025/(250110)三米徒步班"></textarea>
      </div>
    </div>

    <div class="row">
      <label style="display:flex;align-items:center;gap:8px;color:var(--text);margin:0;">
        <input type="checkbox" id="scan_force" style="width:auto;min-height:auto;"> 强制全量重建（忽略目录 mtime）
      </label>
      <div style="text-align:right;display:flex;justify-content:flex-end;gap:8px;flex-wrap:wrap;">
        <button class="btn" id="transcode-detail-btn" onclick="openTranscodeModal()">转码详情</button>
        <button class="btn" id="pause-scan-btn" onclick="pauseScan()">暂停任务</button>
        <button class="btn" id="resume-scan-btn" onclick="resumeScan()">继续任务</button>
        <button class="btn danger" id="abort-scan-btn" onclick="abortScan()">中断任务</button>
        <button class="btn warn" id="start-scan-btn" onclick="startScan()">启动扫描</button>
      </div>
    </div>

    <div class="progress-stack">
      <div class="progress-item">
        <div class="progress-head">
          <span class="progress-title">扫描进度</span>
          <span id="scan-progress-text">0 / 0 · 0%</span>
        </div>
        <div class="progress-track">
          <div class="progress-fill" id="scan-progress-fill"></div>
        </div>
      </div>
      <div class="progress-item">
        <div class="progress-head">
          <span class="progress-title">转码进度 (thumb + preview)</span>
          <span id="transcode-progress-text">0 / 0 · 0%</span>
        </div>
        <div class="progress-track">
          <div class="progress-fill" id="transcode-progress-fill"></div>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:8px;padding:12px;border-radius:14px;box-shadow:none;">
      <div class="status-line" id="scan-status">加载中...</div>
    </div>
  </section>

  <section class="card" id="users-card">
    <h3>用户管理</h3>
    <div class="muted">管理员可新增/编辑/禁用用户</div>
    <div style="height:10px"></div>

    <div class="row4">
      <div>
        <label>用户名</label>
        <input id="new_username">
      </div>
      <div>
        <label>密码 (>=6)</label>
        <input id="new_password" type="password">
      </div>
      <div>
        <label>角色</label>
        <select id="new_role">
          <option value="user">user</option>
          <option value="admin">admin</option>
        </select>
      </div>
      <div style="display:flex;align-items:flex-end;">
        <button class="btn primary" style="width:100%;" onclick="createUser()">新增用户</button>
      </div>
    </div>

    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>用户名</th>
            <th>角色</th>
            <th>启用</th>
            <th>新密码</th>
            <th>操作</th>
          </tr>
        </thead>
        <tbody id="users-body"></tbody>
      </table>
    </div>
  </section>

  <section class="card" id="albums-card">
    <h3>相册发布</h3>
    <div class="muted">发布后才可被普通用户访问；访问权限在下方 ACL 区配置</div>
    <div style="height:10px"></div>

    <div class="row">
      <div>
        <label>按年份过滤</label>
        <input id="album_year_filter" placeholder="2025">
      </div>
      <div>
        <label>按关键字过滤</label>
        <input id="album_q_filter" placeholder="项目名或路径">
      </div>
    </div>
    <div style="margin-bottom:10px;display:flex;gap:8px;">
      <button class="btn" onclick="loadAlbums()">查询</button>
      <button class="btn" onclick="selectFirstAlbum()">选择第一项到 ACL</button>
    </div>

    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>项目</th>
            <th>照片</th>
            <th>发布</th>
            <th>授权</th>
          </tr>
        </thead>
        <tbody id="albums-body"></tbody>
      </table>
    </div>
  </section>

  <section class="card" id="acl-card">
    <h3>ACL 授权</h3>
    <div class="muted">为指定项目分配可见用户（普通用户）</div>
    <div style="height:10px"></div>

    <div class="row">
      <div>
        <label>当前项目</label>
        <input id="acl_album" readonly placeholder="请在上方相册列表点击“授权”">
      </div>
      <div style="display:flex;align-items:flex-end;gap:8px;">
        <button class="btn" onclick="selectAllAclUsers()">全选</button>
        <button class="btn" onclick="clearAclUsers()">清空</button>
        <button class="btn primary" onclick="saveAcl()">保存 ACL</button>
      </div>
    </div>

    <div class="checkbox-list" id="acl-user-list"></div>
  </section>
</main>

<div class="modal-mask" id="update-modal">
  <div class="modal-card">
    <div class="modal-head">
      <div class="modal-title">面板更新进度</div>
      <button class="btn" id="update-close-btn" onclick="closeUpdateModal()">关闭</button>
    </div>
    <div class="muted" id="update-stage-text">等待开始...</div>
    <div style="height:8px"></div>
    <div class="progress-track">
      <div class="progress-fill" id="update-progress-fill"></div>
    </div>
    <div style="height:6px"></div>
    <div class="muted" id="update-progress-text">0%</div>
    <pre class="update-log" id="update-log">暂无日志</pre>
  </div>
</div>

<div class="modal-mask" id="transcode-modal">
  <div class="modal-card">
    <div class="modal-head">
      <div class="modal-title">转码详情 (thumb + preview)</div>
      <button class="btn" id="transcode-close-btn" onclick="closeTranscodeModal()">关闭</button>
    </div>
    <div class="muted" id="transcode-stage-text">等待任务...</div>
    <div style="height:8px"></div>
    <div class="progress-track">
      <div class="progress-fill" id="transcode-modal-progress-fill"></div>
    </div>
    <div style="height:6px"></div>
    <div class="muted" id="transcode-modal-progress-text">0% · 0/0</div>
    <div style="height:8px"></div>
    <div class="muted" id="transcode-current-file">当前/最近文件: -</div>
    <pre class="update-log" id="transcode-log">暂无记录</pre>
  </div>
</div>

<script>
const state = {
  users: [],
  albums: [],
  selectedAlbumId: null,
  selectedAlbumName: '',
  lastScanRunToken: '',
  transcodeAutoShownRun: '',
  transcodeModalManuallyClosed: false,
  scanControlBusyAction: '',
  updatePollTimer: null,
  updateReloadTimer: null,
  updateReloadScheduled: false,
  updateSawRunning: false,
};

const UPDATE_RELOAD_PENDING_KEY = 'photopanel_update_reload_pending';
const UPDATE_RELOAD_DONE_KEY = 'photopanel_update_reload_done';

function qs(id) { return document.getElementById(id); }

function normalizeApiError(message) {
  const msg = String(message || '').trim();
  if (!msg) return '请求失败';
  const idx = msg.indexOf(':');
  const code = idx >= 0 ? msg.slice(0, idx).trim() : msg;
  const detail = idx >= 0 ? msg.slice(idx + 1).trim() : '';
  const map = {
    photo_root_empty: '原图目录不能为空',
    photo_root_must_be_absolute: '原图目录必须是绝对路径',
    photo_root_not_found: '原图目录不存在',
    photo_root_not_directory: '原图目录不是目录',
    photo_root_not_readable: '原图目录不可读',
    cache_root_empty: '缓存目录不能为空',
    cache_root_must_be_absolute: '缓存目录必须是绝对路径',
    cache_root_create_failed: '缓存目录创建失败（权限不足或路径无效）',
    cache_root_not_directory: '缓存目录不是目录',
    cache_root_not_writable: '缓存目录不可写',
    cache_root_prepare_failed: '缓存目录初始化失败',
    scan_running: '已有扫描任务在运行',
    scan_not_running: '当前没有运行中的扫描/转码任务',
    scan_not_paused: '当前任务未暂停',
    scan_abort_already_requested: '已请求中断，正在停止任务',
    scan_control_invalid_action: '无效的任务控制动作',
    panel_update_running: '已有更新任务在运行',
  };
  const readable = map[code] || code;
  return detail ? `${readable}: ${detail}` : readable;
}

async function api(path, options = {}) {
  const res = await fetch(path, options);
  if (res.status === 401) {
    window.location.href = '/login';
    throw new Error('未登录');
  }
  if (!res.ok) {
    let msg = '请求失败';
    try {
      const data = await res.json();
      msg = data.error || msg;
      if (data.detail) msg = `${msg}: ${data.detail}`;
    } catch (_e) {}
    throw new Error(msg);
  }
  const ct = res.headers.get('content-type') || '';
  return ct.includes('application/json') ? res.json() : null;
}

function scanMessageText(code) {
  const map = {
    idle: '空闲',
    running: '运行中',
    pausing: '暂停请求中',
    paused: '已暂停',
    aborting: '中断请求中',
    aborted: '已中断',
    completed: '完成',
    completed_with_limit: '完成（达到限额）',
    completed_no_match: '完成（无匹配项目）',
    completed_with_notice: '完成（有提示）',
    failed: '失败',
  };
  return map[String(code || '')] || String(code || 'unknown');
}

function scanStopReasonText(code) {
  const map = {
    no_album_matched: '没有匹配到任何项目（检查年份/项目路径筛选）',
    max_scan_albums_per_run: '触发项目数量上限',
    time_budget_seconds: '触发时间上限',
    aborted_by_user: '管理员手动中断任务',
    aborted_by_user_forced: '已强制终止任务（用于处理无响应任务）',
    exception: '扫描异常',
    stale_scan_lock_recovered: '检测到旧扫描任务异常中断，已自动恢复',
  };
  return map[String(code || '')] || String(code || '-');
}

function scanPhaseText(code) {
  const map = {
    idle: '空闲',
    scanning: '扫描中',
    transcoding: '转码中',
  };
  return map[String(code || '')] || String(code || '-');
}

async function logout() {
  await api('/api/auth/logout', { method: 'POST' });
  window.location.href = '/login';
}

async function loadSettings() {
  const s = await api('/api/admin/settings');
  const keys = [
    'photo_root', 'cache_root', 'max_scan_albums_per_run', 'max_scan_files_per_album',
    'max_new_thumbs_per_run', 'workers', 'time_budget_seconds', 'preheat_count',
    'thumb_max_edge', 'preview_max_edge', 'webp_method',
    'thumb_quality', 'preview_quality', 'thumb_target_kb', 'preview_target_kb',
    'allowed_extensions', 'exclude_dirs'
  ];
  keys.forEach((k) => { if (qs(k)) qs(k).value = s[k] ?? ''; });
}

async function saveSettings() {
  const btn = qs('save-settings-btn');
  if (btn) btn.disabled = true;
  try {
    const payload = {
      photo_root: qs('photo_root').value.trim(),
      cache_root: qs('cache_root').value.trim(),
      max_scan_albums_per_run: Number(qs('max_scan_albums_per_run').value),
      max_scan_files_per_album: Number(qs('max_scan_files_per_album').value),
      max_new_thumbs_per_run: Number(qs('max_new_thumbs_per_run').value),
      workers: Number(qs('workers').value),
      time_budget_seconds: Number(qs('time_budget_seconds').value),
      preheat_count: Number(qs('preheat_count').value),
      thumb_max_edge: Number(qs('thumb_max_edge').value),
      preview_max_edge: Number(qs('preview_max_edge').value),
      webp_method: Number(qs('webp_method').value),
      thumb_quality: Number(qs('thumb_quality').value),
      preview_quality: Number(qs('preview_quality').value),
      thumb_target_kb: Number(qs('thumb_target_kb').value),
      preview_target_kb: Number(qs('preview_target_kb').value),
      allowed_extensions: qs('allowed_extensions').value.trim(),
      exclude_dirs: qs('exclude_dirs').value.trim(),
    };

    const result = await api('/api/admin/settings', {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload),
    });

    await loadSettings();
    const warnings = Array.isArray(result?.warnings) ? result.warnings : [];
    if (warnings.length > 0) {
      alert(`设置已保存\n${warnings.join('\n')}`);
    } else {
      alert('设置已保存');
    }
  } catch (e) {
    alert(`保存失败: ${normalizeApiError(e.message)}`);
  } finally {
    if (btn) btn.disabled = false;
  }
}

function openUpdateModal() {
  qs('update-modal').classList.add('show');
}

function stopUpdatePolling() {
  if (state.updatePollTimer) {
    clearInterval(state.updatePollTimer);
    state.updatePollTimer = null;
  }
}

function closeUpdateModal() {
  const running = (qs('update-close-btn').dataset.running || '') === '1';
  if (running) return;
  stopUpdatePolling();
  qs('update-modal').classList.remove('show');
}

function openTranscodeModal() {
  qs('transcode-modal').classList.add('show');
  state.transcodeModalManuallyClosed = false;
}

function closeTranscodeModal() {
  qs('transcode-modal').classList.remove('show');
  state.transcodeModalManuallyClosed = true;
}

function hasUpdateReloadPending() {
  try {
    return sessionStorage.getItem(UPDATE_RELOAD_PENDING_KEY) === '1';
  } catch (_e) {
    return false;
  }
}

function setUpdateReloadPending() {
  try {
    sessionStorage.setItem(UPDATE_RELOAD_PENDING_KEY, '1');
  } catch (_e) {}
}

function clearUpdateReloadPending() {
  try {
    sessionStorage.removeItem(UPDATE_RELOAD_PENDING_KEY);
  } catch (_e) {}
}

function getUpdateRunToken(s) {
  const started = Number(s?.started_at || 0);
  const finished = Number(s?.finished_at || 0);
  const updated = Number(s?.updated_at || 0);
  return `${started}:${finished || updated}`;
}

function shouldAutoReloadForCompleted(s) {
  const fromCurrentSession = state.updateSawRunning || hasUpdateReloadPending();
  if (!fromCurrentSession) return false;

  const token = getUpdateRunToken(s);
  if (!token || token === '0:0') return false;

  try {
    if (sessionStorage.getItem(UPDATE_RELOAD_DONE_KEY) === token) {
      clearUpdateReloadPending();
      return false;
    }
    sessionStorage.setItem(UPDATE_RELOAD_DONE_KEY, token);
  } catch (_e) {}

  clearUpdateReloadPending();
  state.updateSawRunning = false;
  return true;
}

function renderPanelUpdateStatus(s) {
  const running = !!s.running;
  if (running) state.updateSawRunning = true;
  qs('update-close-btn').dataset.running = running ? '1' : '0';
  qs('update-close-btn').disabled = running;
  if (qs('panel-update-btn')) qs('panel-update-btn').disabled = running;

  const stage = String(s.stage || '-');
  const stepName = String(s.current_step || '-');
  const pct = clampPct(s.progress_pct || 0);
  const done = Number(s.steps_done || 0);
  const total = Number(s.steps_total || 0);
  const message = String(s.message || 'unknown');
  const messageText = message === 'failed' ? '失败' : (message === 'completed' ? '完成' : '进行中');

  qs('update-stage-text').textContent = `状态: ${messageText} · 阶段: ${stage} · 当前: ${stepName}`;
  qs('update-progress-fill').style.width = `${pct}%`;
  qs('update-progress-text').textContent = `${pct}% · 步骤 ${done}/${total || '?'}`;

  const logEl = qs('update-log');
  const logs = Array.isArray(s.logs) && s.logs.length ? s.logs.join('\n') : '暂无日志';
  const nearBottom = (logEl.scrollHeight - logEl.scrollTop - logEl.clientHeight) < 36;
  logEl.textContent = logs;
  if (nearBottom) logEl.scrollTop = logEl.scrollHeight;

  if (!running) {
    stopUpdatePolling();
    if (message === 'completed') {
      const shouldReload = shouldAutoReloadForCompleted(s);
      if (shouldReload && !state.updateReloadScheduled) {
        state.updateReloadScheduled = true;
        qs('update-stage-text').textContent = '更新完成，正在刷新面板...';
        state.updateReloadTimer = setTimeout(() => {
          window.location.reload();
        }, 1800);
      } else if (!state.updateReloadScheduled) {
        qs('update-stage-text').textContent = '更新完成';
      }
    } else if (message === 'failed') {
      clearUpdateReloadPending();
      const err = s.error ? `，错误: ${s.error}` : '';
      qs('update-stage-text').textContent = `更新失败${err}`;
    }
  }
}

async function loadPanelUpdateStatus() {
  const s = await api('/api/admin/panel-update/status');
  renderPanelUpdateStatus(s);
  return s;
}

function startUpdatePolling() {
  stopUpdatePolling();
  state.updatePollTimer = setInterval(() => {
    loadPanelUpdateStatus().catch(() => {
      qs('update-stage-text').textContent = '连接中断，等待服务恢复...';
    });
  }, 1200);
}

async function startPanelUpdate() {
  if (!confirm('确认执行“一键更新面板”？更新期间会短暂不可用。')) return;

  const btn = qs('panel-update-btn');
  if (btn) btn.disabled = true;
  setUpdateReloadPending();
  if (state.updateReloadTimer) {
    clearTimeout(state.updateReloadTimer);
    state.updateReloadTimer = null;
  }
  state.updateReloadScheduled = false;
  state.updateSawRunning = false;

  openUpdateModal();
  qs('update-stage-text').textContent = '正在启动更新任务...';
  qs('update-progress-fill').style.width = '2%';
  qs('update-progress-text').textContent = '2%';
  qs('update-log').textContent = '任务准备中...';

  try {
    await api('/api/admin/panel-update/start', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({}),
    });
    await loadPanelUpdateStatus();
    startUpdatePolling();
  } catch (e) {
    const msg = normalizeApiError(e.message);
    if (String(e.message || '').includes('panel_update_running')) {
      qs('update-stage-text').textContent = '检测到已有更新任务，正在同步进度...';
      await loadPanelUpdateStatus().catch(() => {});
      startUpdatePolling();
    } else {
      clearUpdateReloadPending();
      qs('update-stage-text').textContent = `更新启动失败: ${msg}`;
      qs('update-close-btn').disabled = false;
      qs('update-close-btn').dataset.running = '0';
    }
  } finally {
    if (btn) btn.disabled = false;
  }
}

async function loadUsers() {
  const data = await api('/api/admin/users');
  state.users = data.users || [];
  renderUsers();
  renderAclUserList();
}

function renderUsers() {
  const body = qs('users-body');
  if (!state.users.length) {
    body.innerHTML = '<tr><td colspan="6" class="muted">暂无用户</td></tr>';
    return;
  }

  let html = '';
  for (const u of state.users) {
    html += `
      <tr>
        <td>${u.id}</td>
        <td><input id="u_name_${u.id}" value="${escapeHtml(u.username)}"></td>
        <td>
          <select id="u_role_${u.id}">
            <option value="user" ${u.role === 'user' ? 'selected' : ''}>user</option>
            <option value="admin" ${u.role === 'admin' ? 'selected' : ''}>admin</option>
          </select>
        </td>
        <td><input id="u_active_${u.id}" type="checkbox" ${u.active ? 'checked' : ''} style="width:auto;min-height:auto;"></td>
        <td><input id="u_pass_${u.id}" type="password" placeholder="留空不改"></td>
        <td><button class="small-btn" onclick="saveUser(${u.id})">保存</button></td>
      </tr>`;
  }
  body.innerHTML = html;
}

async function createUser() {
  const payload = {
    username: qs('new_username').value.trim(),
    password: qs('new_password').value,
    role: qs('new_role').value,
    active: true,
  };

  await api('/api/admin/users', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload),
  });

  qs('new_username').value = '';
  qs('new_password').value = '';
  qs('new_role').value = 'user';
  await loadUsers();
}

async function saveUser(id) {
  const payload = {
    username: qs(`u_name_${id}`).value.trim(),
    role: qs(`u_role_${id}`).value,
    active: qs(`u_active_${id}`).checked,
  };

  const pass = qs(`u_pass_${id}`).value;
  if (pass) payload.password = pass;

  await api(`/api/admin/users/${id}`, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload),
  });

  qs(`u_pass_${id}`).value = '';
  await loadUsers();
}

async function loadAlbums() {
  const year = qs('album_year_filter').value.trim();
  const q = qs('album_q_filter').value.trim();
  const params = new URLSearchParams();
  if (year) params.set('year', year);
  if (q) params.set('q', q);

  const data = await api(`/api/admin/albums?${params.toString()}`);
  state.albums = data.albums || [];
  renderAlbums();
}

function renderAlbums() {
  const body = qs('albums-body');
  if (!state.albums.length) {
    body.innerHTML = '<tr><td colspan="5" class="muted">暂无相册，请先扫描</td></tr>';
    return;
  }

  let html = '';
  for (const a of state.albums) {
    html += `
      <tr>
        <td>${a.id}</td>
        <td>
          <div><strong>${escapeHtml(a.name)}</strong></div>
          <div class="muted">${escapeHtml(a.rel_path)}</div>
        </td>
        <td>${a.photo_count}</td>
        <td>
          <label style="display:flex;align-items:center;gap:8px;color:var(--text);">
            <input type="checkbox" style="width:auto;min-height:auto;" ${a.published ? 'checked' : ''}
              onchange="togglePublish(${a.id}, this.checked)">
            ${a.published ? '已发布' : '未发布'}
          </label>
        </td>
        <td>
          <button class="small-btn" onclick="selectAlbumForAcl(${a.id})">授权</button>
        </td>
      </tr>`;
  }
  body.innerHTML = html;
}

async function togglePublish(albumId, published) {
  try {
    await api(`/api/admin/albums/${albumId}/publish`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ published }),
    });
  } catch (e) {
    alert(`发布状态更新失败: ${e.message}`);
  }
  await loadAlbums();
}

function selectFirstAlbum() {
  if (!state.albums.length) return;
  selectAlbumForAcl(state.albums[0].id);
}

function selectAlbumForAcl(albumId) {
  const album = state.albums.find(a => a.id === albumId);
  if (!album) return;

  state.selectedAlbumId = album.id;
  state.selectedAlbumName = `${album.rel_path} (#${album.id})`;
  qs('acl_album').value = state.selectedAlbumName;

  renderAclUserList(album.acl_user_ids || []);
}

function renderAclUserList(selectedIds = null) {
  const list = qs('acl-user-list');
  const selected = new Set(selectedIds !== null
    ? selectedIds
    : (state.albums.find(a => a.id === state.selectedAlbumId)?.acl_user_ids || []));

  const normalUsers = state.users.filter(u => u.role === 'user' && u.active);
  if (!normalUsers.length) {
    list.innerHTML = '<div class="muted">暂无可分配的普通用户</div>';
    return;
  }

  let html = '';
  for (const u of normalUsers) {
    html += `
      <label>
        <input type="checkbox" value="${u.id}" ${selected.has(u.id) ? 'checked' : ''}>
        <span>${escapeHtml(u.username)} (ID: ${u.id})</span>
      </label>`;
  }

  list.innerHTML = html;
}

function getSelectedAclUserIds() {
  const ids = [];
  qs('acl-user-list').querySelectorAll('input[type="checkbox"]:checked').forEach((el) => {
    ids.push(Number(el.value));
  });
  return ids;
}

function selectAllAclUsers() {
  qs('acl-user-list').querySelectorAll('input[type="checkbox"]').forEach((el) => { el.checked = true; });
}

function clearAclUsers() {
  qs('acl-user-list').querySelectorAll('input[type="checkbox"]').forEach((el) => { el.checked = false; });
}

async function saveAcl() {
  if (!state.selectedAlbumId) {
    alert('请先在上方相册列表中点击“授权”选择项目');
    return;
  }

  const user_ids = getSelectedAclUserIds();
  await api(`/api/admin/albums/${state.selectedAlbumId}/acl`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ user_ids }),
  });

  await loadAlbums();
  selectAlbumForAcl(state.selectedAlbumId);
  alert('ACL 已保存');
}

function setScanControlButtons(s) {
  const running = !!s.running;
  const paused = !!s.paused;
  const pauseRequested = !!s.pause_requested;
  const abortRequested = !!s.abort_requested;
  const busyAction = String(state.scanControlBusyAction || '');

  const startBtn = qs('start-scan-btn');
  const pauseBtn = qs('pause-scan-btn');
  const resumeBtn = qs('resume-scan-btn');
  const abortBtn = qs('abort-scan-btn');

  if (startBtn) {
    startBtn.disabled = running || !!busyAction;
    startBtn.textContent = running ? '扫描进行中' : '启动扫描';
  }
  if (pauseBtn) {
    pauseBtn.disabled = !running || paused || pauseRequested || abortRequested || !!busyAction;
    pauseBtn.textContent = busyAction === 'pause'
      ? '暂停请求中...'
      : (pauseRequested && !paused ? '暂停中...' : '暂停任务');
  }
  if (resumeBtn) {
    resumeBtn.disabled = !running || (!paused && !pauseRequested) || abortRequested || !!busyAction;
    resumeBtn.textContent = busyAction === 'resume' ? '继续中...' : '继续任务';
  }
  if (abortBtn) {
    abortBtn.disabled = !running || !!busyAction;
    abortBtn.textContent = busyAction === 'abort'
      ? '中断请求中...'
      : (abortRequested ? '强制中断' : '中断任务');
  }
}

async function sendScanControl(action) {
  if (state.scanControlBusyAction) return;
  state.scanControlBusyAction = action;
  setScanControlButtons({
    running: true,
    paused: false,
    pause_requested: action === 'pause',
    abort_requested: action === 'abort',
  });
  try {
    await api('/api/admin/albums/scan/control', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ action }),
    });
  } catch (e) {
    alert(`任务控制失败: ${normalizeApiError(e.message)}`);
  } finally {
    state.scanControlBusyAction = '';
    await loadScanStatus().catch(() => {});
  }
}

async function pauseScan() {
  await sendScanControl('pause');
}

async function resumeScan() {
  await sendScanControl('resume');
}

async function abortScan() {
  const aborting = (qs('abort-scan-btn')?.textContent || '').includes('强制');
  const msg = aborting
    ? '任务仍未停止，是否执行强制中断并回收卡住状态？'
    : '确认中断当前扫描与转码任务？该操作不可恢复。';
  if (!confirm(msg)) return;
  await sendScanControl('abort');
}

async function startScan() {
  if (state.scanControlBusyAction) return;
  state.scanControlBusyAction = 'start';
  setScanControlButtons({ running: true, paused: false, pause_requested: false, abort_requested: false });
  state.transcodeModalManuallyClosed = false;
  try {
    const years = qs('scan_years').value
      .split(/[,\uFF0C]/)
      .map(v => v.trim())
      .filter(Boolean);

    const album_paths = qs('scan_album_paths').value
      .split(/\r?\n/)
      .map(v => v.trim().replaceAll('\\', '/').replace(/^\/+|\/+$/g, ''))
      .filter(Boolean);

    const force = qs('scan_force').checked;

    await api('/api/admin/albums/scan', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ years, album_paths, force }),
    });

    await loadScanStatus();
    alert('扫描任务已启动');
  } catch (e) {
    alert(`启动扫描失败: ${normalizeApiError(e.message)}`);
  } finally {
    state.scanControlBusyAction = '';
    await loadScanStatus().catch(() => {});
  }
}

function clampPct(v) {
  const n = Number(v) || 0;
  if (n < 0) return 0;
  if (n > 100) return 100;
  return Math.round(n);
}

function setProgress(fillId, textId, done, total, pct) {
  const safeDone = Number(done) || 0;
  const safeTotal = Number(total) || 0;
  const safePct = clampPct(pct);
  qs(fillId).style.width = `${safePct}%`;
  qs(textId).textContent = `${safeDone} / ${safeTotal} · ${safePct}%`;
}

function renderTranscodeModal(s, transDone, transTotal, transPct) {
  const running = !!s.running;
  let stageText = '当前无转码队列';
  if (s.abort_requested) {
    stageText = '任务中断中...';
  } else if (s.paused) {
    stageText = '任务已暂停（扫描/转码）';
  } else if (s.pause_requested && running) {
    stageText = '任务暂停中（等待安全暂停点）';
  } else if (running && transTotal > 0) {
    stageText = '转码任务运行中';
  } else if (running && transTotal <= 0) {
    stageText = '扫描运行中，等待转码队列';
  } else if (!running && transTotal > 0) {
    stageText = '转码任务已结束';
  }
  qs('transcode-stage-text').textContent = stageText;
  qs('transcode-modal-progress-fill').style.width = `${clampPct(transPct)}%`;
  qs('transcode-modal-progress-text').textContent = `${clampPct(transPct)}% · ${transDone}/${transTotal}`;

  const currentFile = String(s.current_cache_file || '').trim();
  qs('transcode-current-file').textContent = `当前/最近文件: ${currentFile || (running ? '等待分配...' : '-')}`;

  const logEl = qs('transcode-log');
  const logs = Array.isArray(s.recent_cache_items) && s.recent_cache_items.length
    ? s.recent_cache_items.join('\n')
    : '暂无记录';
  const nearBottom = (logEl.scrollHeight - logEl.scrollTop - logEl.clientHeight) < 36;
  logEl.textContent = logs;
  if (nearBottom) logEl.scrollTop = logEl.scrollHeight;
}

function syncTranscodeModalAutoOpen(s, transTotal) {
  const runToken = String(s.started_at || '');
  if (runToken && runToken !== state.lastScanRunToken) {
    state.lastScanRunToken = runToken;
    state.transcodeAutoShownRun = '';
    state.transcodeModalManuallyClosed = false;
  }

  if (
    s.running &&
    transTotal > 0 &&
    runToken &&
    state.transcodeAutoShownRun !== runToken &&
    !state.transcodeModalManuallyClosed
  ) {
    openTranscodeModal();
    state.transcodeAutoShownRun = runToken;
  }
}

async function loadScanStatus() {
  const s = await api('/api/admin/scan-status');
  setScanControlButtons(s);

  const scanTotal = s.scan_target_albums || s.found_albums || 0;
  const scanDone = s.scan_done_albums || ((s.processed_albums || 0) + (s.skipped_albums || 0));
  const scanPct = s.scan_progress_pct || 0;
  setProgress('scan-progress-fill', 'scan-progress-text', scanDone, scanTotal, scanPct);

  const transTotal = s.total_cache_tasks || 0;
  const transDone = s.transcode_done_tasks || s.completed_cache_tasks || 0;
  const transPct = s.transcode_progress_pct || 0;
  setProgress('transcode-progress-fill', 'transcode-progress-text', transDone, transTotal, transPct);
  renderTranscodeModal(s, transDone, transTotal, transPct);
  syncTranscodeModalAutoOpen(s, transTotal);

  const lines = [];
  lines.push(`状态: ${scanMessageText(s.message || 'unknown')}${s.running ? ' (running)' : ''}`);
  lines.push(`阶段: ${scanPhaseText(s.phase || (s.running ? 'scanning' : 'idle'))}`);
  if (s.pause_requested && !s.paused) lines.push('控制: 已请求暂停，等待任务进入可暂停点');
  if (s.paused) lines.push('控制: 任务已暂停，可点击“继续任务”恢复');
  if (s.abort_requested) lines.push('控制: 已请求中断，正在停止任务');
  if (s.scan_lock_running && !s.running) lines.push('提示: 扫描锁仍占用，系统会自动释放过期锁');
  lines.push(`开始: ${s.started_at ? new Date(s.started_at * 1000).toLocaleString() : '-'}`);
  lines.push(`结束: ${s.finished_at ? new Date(s.finished_at * 1000).toLocaleString() : '-'}`);
  lines.push(`项目进度: ${scanDone}/${scanTotal} (${scanPct}%)`);
  lines.push(`处理项目: ${s.processed_albums || 0}，跳过项目: ${s.skipped_albums || 0}`);
  lines.push(`扫描文件: ${s.scanned_files || 0}，更新文件: ${s.updated_files || 0}，删除文件: ${s.deleted_files || 0}`);
  lines.push(`转码进度: ${transDone}/${transTotal} (${transPct}%)，实际生成缓存对: ${s.generated_cache_pairs || 0}`);
  if (s.stop_reason) lines.push(`停止原因: ${scanStopReasonText(s.stop_reason)}`);
  if (s.photo_root_ok === false) {
    const detail = s.photo_root_error_detail ? ` (${s.photo_root_error_detail})` : '';
    lines.push(`PHOTO_ROOT 异常: ${normalizeApiError(s.photo_root_error)}${detail}`);
  }
  if (s.last_scan_summary && Object.keys(s.last_scan_summary).length) {
    lines.push('最近任务摘要:');
    lines.push(JSON.stringify(s.last_scan_summary, null, 2));
  }

  qs('scan-status').textContent = lines.join('\n');
}

function escapeHtml(v) {
  return String(v)
    .replaceAll('&', '&amp;')
    .replaceAll('<', '&lt;')
    .replaceAll('>', '&gt;')
    .replaceAll('"', '&quot;')
    .replaceAll("'", '&#39;');
}

async function init() {
  try {
    await Promise.all([loadSettings(), loadUsers(), loadAlbums(), loadScanStatus()]);
  } catch (e) {
    alert(`初始化失败: ${e.message}`);
  }

  try {
    const updateStatus = await api('/api/admin/panel-update/status');
    const shouldShowCompleted = updateStatus.message === 'completed' && hasUpdateReloadPending();
    if (updateStatus.running || updateStatus.message === 'failed' || shouldShowCompleted) {
      openUpdateModal();
      renderPanelUpdateStatus(updateStatus);
      if (updateStatus.running) startUpdatePolling();
    }
  } catch (_e) {}

  setInterval(() => {
    loadScanStatus().catch(() => {});
  }, 1500);
}

init();
</script>
</body>
</html>
